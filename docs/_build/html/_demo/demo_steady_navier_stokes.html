

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demo: Steady Navier-Stokes &mdash; flatiron_tk 0.9.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=39bb1c6d"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script>window.MathJax = {"chtml": {"displayAlign": "center"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Demo: Steady Stokes with External Body Force" href="demo_steady_stokes.html" />
    <link rel="prev" title="Demo: Steady Multiphysics Simulation (Coupled Diffusion Reaction)" href="demo_steady_multiphysics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            flatiron_tk
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toc_modules.html">FLATiron Modules</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../toc_demos.html">FLATiron Demos</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="demo_adios4dolfinx.html">Demo: Using ADIOS4DOLFINx</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_block_solver_nse.html">Demo: Using the Block Solver for the Navier-Stokes Equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_block_solver_gp.html">Demo: Using the Block Solver with Nested Splits</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_functions.html">Demo: Using the Functions Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_scalar_transport_edge_stab.html">Demo: Advection-Diffusion-Reaction with Jump (Edge) Stabilization</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_steady_adr.html">Demo: Steady Advection-Diffusion-Reaction Equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_steady_multiphysics.html">Demo: Steady Multiphysics Simulation (Coupled Diffusion Reaction)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Demo: Steady Navier-Stokes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#full-script">Full Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="demo_steady_stokes.html">Demo: Steady Stokes with External Body Force</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_transient_adr.html">Demo: Transient Advection-Diffusion-Reaction Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_transient_navier_stokes.html">Demo: Transient Navier-Stokes</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">flatiron_tk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../toc_demos.html">FLATiron Demos</a></li>
      <li class="breadcrumb-item active">Demo: Steady Navier-Stokes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/_demo/demo_steady_navier_stokes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="demo-steady-navier-stokes">
<h1>Demo: Steady Navier-Stokes<a class="headerlink" href="#demo-steady-navier-stokes" title="Link to this heading"></a></h1>
<p>This demo code demonstrates how to solve a steady state incompressible Navier-Stokes equation using the canonical lid driven cavity problem.
The full source code can be found in <strong>demo/demo_steady_navier_stokes/demo_steady_navier_stokes.py</strong>.</p>
<p>This problem is the steady state incompressible Navier-Stokes problem in a unit square domain.</p>
<p>Strong form</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\begin{split}\rho \textbf{u} \cdot \nabla \textbf{u} = \boldsymbol{\sigma} + \textbf{b} \\\end{split}\\\nabla \cdot \textbf{u} = 0\end{aligned}\end{align} \]</div>
<p>Where the stress term is</p>
<div class="math notranslate nohighlight">
\[\boldsymbol{\sigma} = -p\textbf{I} + \mu\left(\nabla \textbf{u} + \nabla \textbf{u}^T \right)\]</div>
<p>The boundary conditions are</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\begin{split}\textbf{u}(x=0) = \textbf{u}(x=1) = \textbf{u}(y=0) = \textbf{0} \\\end{split}\\\begin{split}\textbf{u}(y=1) = (1, 0) \\\end{split}\\p(x=0,y=0) = 0\end{aligned}\end{align} \]</div>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h2>
<p>First we import the relevant modules and define functions representing the boundary conditions.</p>
<p>Next, we define the mesh.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create mesh</span>
<span class="n">ne</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">RectMesh</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">ne</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we define the incompressible Navier Stokes solver using the <code class="docutils literal notranslate"><span class="pre">SteadyNavierStokes</span></code> physics.
Here we will use the <em>unstable</em> elements combination Q1P1 and we will add stabilization.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build Navier-Stokes problem</span>
<span class="n">nse</span> <span class="o">=</span> <span class="n">SteadyNavierStokes</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_element</span><span class="p">(</span><span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">nse</span><span class="o">.</span><span class="n">build_function_space</span><span class="p">()</span>
</pre></div>
</div>
<p>Next the problem parameters are defined and the weak formulation is set. We call <code class="docutils literal notranslate"><span class="pre">add_stab()</span></code> to add the stabilization terms.
In this implementation, we include both the SUPG and PSPG stabilization.
Please see <a class="reference internal" href="../_modules/physics_modules/module_navier-stokes.html"><span class="doc">Steady Navier Stokes Physics</span></a> for more detail.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set physical parameters</span>
<span class="n">Re</span> <span class="o">=</span> <span class="mf">100.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">Re</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_dynamic_viscosity</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="c1"># Set weak form and stabilization</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_weak_form</span><span class="p">()</span>
<span class="n">nse</span><span class="o">.</span><span class="n">add_stab</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, we define the boundary conditions. We use the previously defined functions to set the velocity on the walls and lid,
and we set a zero pressure point constraint at the bottom left corner of the domain. The boundary conditions
are defined above as arrays and passed onto dolfinx Function objects built off the sub spaces of the mixed function space.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create boundary condition functions</span>
<span class="n">zero_v</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_u</span><span class="p">)</span>
<span class="n">zero_v</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">no_slip</span><span class="p">)</span>
<span class="n">inlet_v</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_u</span><span class="p">)</span>
<span class="n">inlet_v</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">u_inlet</span><span class="p">)</span>
<span class="n">zero_p</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_p</span><span class="p">)</span>
<span class="n">zero_p</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Define boundary conditions</span>
<span class="n">u_bcs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_v</span><span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_v</span><span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_v</span><span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">inlet_v</span><span class="p">},</span>
        <span class="p">}</span>

<span class="n">p_bcs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_p</span><span class="p">},</span>
        <span class="p">}</span>

<span class="n">bc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">u_bcs</span><span class="p">,</span>
        <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">p_bcs</span><span class="p">}</span>

<span class="n">nse</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">bc_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we define the nonlinear problem and solver. We use a Krylov solver and adjust
the solver parameter using a function that sets the PETSc KSP options.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define problem</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">NonLinearProblem</span><span class="p">(</span><span class="n">nse</span><span class="p">)</span>

<span class="c1"># Custom KSP setup function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_custom_ksp_setup</span><span class="p">(</span><span class="n">ksp</span><span class="p">):</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">ksp</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">FGMRES</span><span class="p">)</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">ksp</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">LU</span><span class="p">)</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_it</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">setMonitor</span><span class="p">(</span><span class="n">ConvergenceMonitor</span><span class="p">(</span><span class="s1">&#39;ksp&#39;</span><span class="p">))</span>

<span class="c1"># Create nonlinear solver</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">NonLinearSolver</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">outer_ksp_set_function</span><span class="o">=</span><span class="n">my_custom_ksp_setup</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we solve the problem and write the results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solve the problem</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">nse</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>The solution is shown below.</p>
<a class="reference internal image-reference" href="../_images/LDC.png"><img alt="../_images/LDC.png" class="align-center" src="../_images/LDC.png" style="width: 600px;" />
</a>
</section>
<section id="full-script">
<h2>Full Script<a class="headerlink" href="#full-script" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dolfinx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flatiron_tk.mesh</span><span class="w"> </span><span class="kn">import</span> <span class="n">RectMesh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flatiron_tk.physics</span><span class="w"> </span><span class="kn">import</span> <span class="n">SteadyNavierStokes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flatiron_tk.solver</span><span class="w">  </span><span class="kn">import</span> <span class="n">ConvergenceMonitor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flatiron_tk.solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">NonLinearProblem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flatiron_tk.solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">NonLinearSolver</span>

<span class="c1"># Define boundary conditions functions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">no_slip</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">u_inlet</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">zero_pressure</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">)</span>

<span class="c1"># Create mesh</span>
<span class="n">ne</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">RectMesh</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">ne</span><span class="p">)</span>

<span class="c1"># Build Navier-Stokes problem</span>
<span class="n">nse</span> <span class="o">=</span> <span class="n">SteadyNavierStokes</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_element</span><span class="p">(</span><span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">nse</span><span class="o">.</span><span class="n">build_function_space</span><span class="p">()</span>

<span class="c1"># Set physical parameters</span>
<span class="n">Re</span> <span class="o">=</span> <span class="mf">100.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">Re</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_dynamic_viscosity</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="c1"># Set weak form and stabilization</span>
<span class="n">nse</span><span class="o">.</span><span class="n">set_weak_form</span><span class="p">()</span>
<span class="n">nse</span><span class="o">.</span><span class="n">add_stab</span><span class="p">()</span>

<span class="c1"># Velocity and pressure subspaces</span>
<span class="n">V_u</span> <span class="o">=</span> <span class="n">nse</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">V_p</span> <span class="o">=</span> <span class="n">nse</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Create boundary condition functions</span>
<span class="n">zero_v</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_u</span><span class="p">)</span>
<span class="n">zero_v</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">no_slip</span><span class="p">)</span>
<span class="n">inlet_v</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_u</span><span class="p">)</span>
<span class="n">inlet_v</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">u_inlet</span><span class="p">)</span>
<span class="n">zero_p</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_p</span><span class="p">)</span>
<span class="n">zero_p</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Define boundary conditions</span>
<span class="n">u_bcs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_v</span><span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_v</span><span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_v</span><span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">inlet_v</span><span class="p">},</span>
        <span class="p">}</span>

<span class="n">p_bcs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dirichlet&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">zero_p</span><span class="p">},</span>
        <span class="p">}</span>

<span class="n">bc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">u_bcs</span><span class="p">,</span>
        <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">p_bcs</span><span class="p">}</span>

<span class="n">nse</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">bc_dict</span><span class="p">)</span>

<span class="n">nse</span><span class="o">.</span><span class="n">set_writer</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;pvd&#39;</span><span class="p">)</span>

<span class="c1"># Define problem</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">NonLinearProblem</span><span class="p">(</span><span class="n">nse</span><span class="p">)</span>

<span class="c1"># Custom KSP setup function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_custom_ksp_setup</span><span class="p">(</span><span class="n">ksp</span><span class="p">):</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">ksp</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">FGMRES</span><span class="p">)</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">ksp</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">LU</span><span class="p">)</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_it</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">setMonitor</span><span class="p">(</span><span class="n">ConvergenceMonitor</span><span class="p">(</span><span class="s1">&#39;ksp&#39;</span><span class="p">))</span>

<span class="c1"># Create nonlinear solver</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">NonLinearSolver</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">outer_ksp_set_function</span><span class="o">=</span><span class="n">my_custom_ksp_setup</span><span class="p">)</span>

<span class="c1"># Solve the problem</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">nse</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demo_steady_multiphysics.html" class="btn btn-neutral float-left" title="Demo: Steady Multiphysics Simulation (Coupled Diffusion Reaction)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="demo_steady_stokes.html" class="btn btn-neutral float-right" title="Demo: Steady Stokes with External Body Force" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Nick Rovito.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>